AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Full SAM application with multiple resources

Parameters:
  Environment:
    Type: String
    Default: dev
    AllowedValues:
      - dev
      - staging
      - prod
  LogLevel:
    Type: String
    Default: INFO

Globals:
  Function:
    Timeout: 30
    Runtime: python3.12
    MemorySize: 256
    Tracing: Active
    Environment:
      Variables:
        ENVIRONMENT: !Ref Environment
        LOG_LEVEL: !Ref LogLevel
        TABLE_NAME: !Ref DataTable
    Layers:
      - !Ref CommonLayer

Resources:
  # Shared Lambda Layer
  CommonLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: !Sub "${AWS::StackName}-common"
      Description: Common utilities layer
      ContentUri: layers/common/
      CompatibleRuntimes:
        - python3.12
      RetentionPolicy: Delete

  # API Gateway
  RestApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: !Ref Environment
      TracingEnabled: true
      MethodSettings:
        - ResourcePath: "/*"
          HttpMethod: "*"
          LoggingLevel: INFO
          DataTraceEnabled: true
          MetricsEnabled: true

  # CRUD Functions
  CreateItemFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-create"
      Handler: crud.create_handler
      CodeUri: src/
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref DataTable
      Events:
        CreateItem:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /items
            Method: post

  GetItemFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-get"
      Handler: crud.get_handler
      CodeUri: src/
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref DataTable
      Events:
        GetItem:
          Type: Api
          Properties:
            RestApiId: !Ref RestApi
            Path: /items/{id}
            Method: get

  # Event-driven functions
  StreamProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-stream-processor"
      Handler: streams.handler
      CodeUri: src/
      Policies:
        - SQSSendMessagePolicy:
            QueueName: !GetAtt NotificationQueue.QueueName
      Events:
        DynamoDBStream:
          Type: DynamoDB
          Properties:
            Stream: !GetAtt DataTable.StreamArn
            StartingPosition: TRIM_HORIZON
            BatchSize: 100
            MaximumBatchingWindowInSeconds: 5

  # Scheduled function
  CleanupFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-cleanup"
      Handler: cleanup.handler
      CodeUri: src/
      Timeout: 300
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref DataTable
      Events:
        ScheduledCleanup:
          Type: Schedule
          Properties:
            Schedule: rate(1 day)
            Description: Daily cleanup job

  # Step Functions State Machine
  ProcessingStateMachine:
    Type: AWS::Serverless::StateMachine
    Properties:
      Name: !Sub "${AWS::StackName}-workflow"
      DefinitionUri: statemachine/workflow.asl.json
      DefinitionSubstitutions:
        ProcessorFunctionArn: !GetAtt StreamProcessorFunction.Arn
      Policies:
        - LambdaInvokePolicy:
            FunctionName: !Ref StreamProcessorFunction

  # DynamoDB Table with streams
  DataTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "${AWS::StackName}-data"
      BillingMode: PAY_PER_REQUEST
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
      KeySchema:
        - AttributeName: pk
          KeyType: HASH
        - AttributeName: sk
          KeyType: RANGE

  # SQS Queues
  NotificationQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub "${AWS::StackName}-notifications"
      VisibilityTimeout: 300

  # SNS Topics
  AlertTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Sub "${AWS::StackName}-alerts"

  # CloudWatch Alarms
  ErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AWS::StackName}-errors"
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 5
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref CreateItemFunction
      AlarmActions:
        - !Ref AlertTopic

Outputs:
  ApiUrl:
    Description: API Gateway endpoint URL
    Value: !Sub "https://${RestApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}/"
  TableName:
    Description: DynamoDB table name
    Value: !Ref DataTable
  StateMachineArn:
    Description: State Machine ARN
    Value: !Ref ProcessingStateMachine
